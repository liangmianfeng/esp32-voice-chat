<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ESP32 è¯­éŸ³å¯¹è®²</title>
  <style>
    body { font-family: "Segoe UI", sans-serif; background:#0f172a; color:#f8fafc; text-align:center; padding:40px;}
    button { font-size:18px; padding:12px 24px; margin:10px; border-radius:12px; border:none; cursor:pointer; background:#2563eb; color:white; transition:0.3s;}
    button:hover { background:#1d4ed8;}
    h1 { color:#38bdf8;}
  </style>
</head>
<body>
  <h1>ğŸŒ ESP32 è¯­éŸ³å¯¹è®²</h1>
  <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸ ESP32 è¿›è¡Œè¯­éŸ³é€šè¯ï¼š</p>
  <button id="btnStart">ğŸ¤ å¼€å§‹å¯¹è®²</button>
  <button id="btnStop">â›” åœæ­¢å¯¹è®²</button>

  <script>
    const wsUrl = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/";
    const ws = new WebSocket(wsUrl);
    ws.binaryType = "arraybuffer";

    let mediaStream;
    let audioPlayer = new Audio();
    audioPlayer.autoplay = true;

    ws.onopen = () => console.log("âœ… WebSocket å·²è¿æ¥:", wsUrl);
    ws.onmessage = (e) => {
      if (e.data instanceof ArrayBuffer) {
        const blob = new Blob([e.data], { type: "audio/wav" });
        audioPlayer.src = URL.createObjectURL(blob);
      } else {
        console.log("ğŸ“©", e.data);
      }
    };

    document.getElementById("btnStart").onclick = async () => {
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const audioCtx = new AudioContext({ sampleRate: 16000 });
      const source = audioCtx.createMediaStreamSource(mediaStream);
      const processor = audioCtx.createScriptProcessor(1024, 1, 1);
      source.connect(processor);
      processor.connect(audioCtx.destination);

      processor.onaudioprocess = (e) => {
        const input = e.inputBuffer.getChannelData(0);
        const buffer = new Int16Array(input.length);
        for (let i = 0; i < input.length; i++) {
          buffer[i] = Math.max(-1, Math.min(1, input[i])) * 0x7fff;
        }
        if (ws.readyState === WebSocket.OPEN) ws.send(buffer);
      };
      alert("ğŸ¤ æ­£åœ¨å½•éŸ³å¹¶ä¼ è¾“...");
    };

    document.getElementById("btnStop").onclick = () => {
      if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
      alert("ğŸ›‘ å¯¹è®²å·²åœæ­¢");
    };
  </script>
</body>
</html>
